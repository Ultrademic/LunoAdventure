<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Luno's Open World Adventure - Pedestrian Pickup, Enhanced Buildings, and New Features</title><style>body{margin:0;overflow:hidden;background:#000}canvas{display:block}#ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}#error-message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:red;font-family:Arial,sans-serif;font-size:24px;text-align:center;display:none}#skill-bar{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:10;pointer-events:auto}.skill{width:40px;height:40px;background:#444;color:white;text-align:center;line-height:40px;cursor:pointer;font-family:Arial,sans-serif}.skill:hover{background:#666}#xp-bar{width:200px;height:20px;background:#333;position:absolute;top:60px;left:10px;pointer-events:none}#xp-fill{height:100%;background:blue;width:0%}#health-bar{width:200px;height:20px;background:red;position:absolute;top:110px;left:10px;pointer-events:none}#health-fill{height:100%;background:green;width:100%}#level-display{position:absolute;top:30px;left:10px;font-size:16px;color:white;font-family:Arial,sans-serif;text-shadow:1px 1px 2px black;pointer-events:none}#xp-counter{position:absolute;top:90px;left:10px;font-size:16px;color:white;font-family:Arial,sans-serif;text-shadow:1px 1px 2px black;pointer-events:none}#clock-canvas{position:absolute;top:140px;left:10px;width:50px;height:50px;pointer-events:none}#quest-tracker{position:absolute;top:180px;left:10px;font-size:16px;color:white;font-family:Arial,sans-serif;text-shadow:1px 1px 2px black;display:none;pointer-events:none}#inventory{position:absolute;top:220px;left:10px;background:rgba(0,0,0,0.7);padding:10px;display:none;pointer-events:auto}#inventory-grid{display:grid;grid-template-columns:repeat(5,40px);gap:5px}.inventory-slot{width:40px;height:40px;background:#333;border:1px solid #555;text-align:center;line-height:40px;color:white;font-size:12px;cursor:pointer}.inventory-slot:hover{background:#555}#character-display{position:absolute;top:220px;left:220px;background:rgba(0,0,0,0.7);padding:10px;color:white;font-family:Arial,sans-serif;font-size:14px;display:none;pointer-events:auto;z-index:10;width:150px}#character-canvas{width:100px;height:100px;border:2px solid #555;margin-bottom:10px}#equipped-gear{margin-bottom:10px}#unequip-button{background:#444;color:white;padding:5px 10px;cursor:pointer;font-family:Arial,sans-serif;border:none}#unequip-button:hover{background:#666}#unequip-mount-button{background:#444;color:white;padding:5px 10px;cursor:pointer;font-family:Arial,sans-serif;border:none}#unequip-mount-button:hover{background:#666}#npc-message{position:absolute;top:300px;left:10px;background:rgba(0,0,0,0.7);padding:10px;color:white;display:none;font-family:Arial,sans-serif;pointer-events:none;z-index:15}#npc-message-content{margin-bottom:10px}#npc-message-buttons{display:flex;gap:10px;pointer-events:auto;z-index:20}.npc-button{background:#444;color:white;padding:5px 10px;cursor:pointer;font-family:Arial,sans-serif;z-index:20}.npc-button:hover{background:#666}#minimap{position:absolute;top:10px;right:10px;width:150px;height:150px;border:2px solid #555;background:rgba(0,0,0,0.5);pointer-events:none}#level-up-popup,#quest-received-popup{position:absolute;top:30%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;font-family:Arial,sans-serif;font-size:24px;text-align:center;border:2px solid #ffd700;display:none;z-index:20;pointer-events:none;opacity:0;transition:opacity 0.5s ease-in-out}#pickup-message{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:10px;font-family:Arial,sans-serif;font-size:16px;text-align:center;border:1px solid #ffd700;display:none;opacity:0;transition:opacity 0.5s ease-in-out}#touch-controls{position:absolute;bottom:0;left:0;width:100%;height:100%;pointer-events:none}#joystick-base{position:absolute;bottom:20px;left:20px;width:80px;height:80px;background:rgba(255,255,255,0.3);border-radius:50%;pointer-events:auto}#joystick{position:absolute;width:40px;height:40px;background:rgba(255,255,255,0.5);border-radius:50%;top:20px;left:20px;pointer-events:none}#skill1-touch,#skill2-touch,#skill3-touch,#interact-touch,#inventory-touch,#tractor-beam-touch,#launch-touch{position:absolute;background:#444;color:white;padding:10px;border-radius:5px;pointer-events:auto;font-size:16px;font-family:Arial,sans-serif;border:none}#skill1-touch{top:60%;right:20px}#skill2-touch{top:70%;right:20px}#skill3-touch{top:80%;right:20px}#interact-touch{bottom:20px;right:80px}#inventory-touch{bottom:20px;right:20px}#tractor-beam-touch{bottom:80px;right:20px;display:none}#launch-touch{bottom:140px;right:20px;display:none}</style></head><body><div id="ui"><div id="level-display">Level: 1</div><div id="xp-bar"><div id="xp-fill"></div></div><div id="xp-counter">XP: 0/25</div><div id="health-bar"><div id="health-fill"></div></div><canvas id="clock-canvas"></canvas><div id="quest-tracker"></div><div id="inventory"><div id="inventory-grid"></div></div><div id="character-display"><canvas id="character-canvas"></canvas><div id="equipped-gear">Head: None</div><button id="unequip-button" style="display:none;">Unequip Hat</button><button id="unequip-mount-button" style="display:none;">Unequip Mount</button></div><canvas id="minimap"></canvas><div id="npc-message"><div id="npc-message-content"></div><div id="npc-message-buttons"><button id="accept-quest-button" class="npc-button">Accept</button><button id="decline-quest-button" class="npc-button">Decline</button></div></div><div id="level-up-popup"></div><div id="quest-received-popup"></div><div id="pickup-message"></div><div id="touch-controls"><div id="joystick-base"><div id="joystick"></div></div><button id="skill1-touch">Swing</button><button id="skill2-touch">Stab</button><button id="skill3-touch">Spin</button><button id="interact-touch">Interact</button><button id="inventory-touch">I</button><button id="tractor-beam-touch">Beam</button><button id="launch-touch">Launch</button></div></div><div id="skill-bar"><div class="skill" id="skill1">Swing</div><div class="skill" id="skill2">Stab</div><div class="skill" id="skill3">Spin</div></div><div id="error-message"></div><script src="three.min.js"></script><script>if(typeof THREE==='undefined'){console.error('Three.js not loaded. Please ensure three.min.js is in the www directory.');document.getElementById('error-message').style.display='block';document.getElementById('error-message').textContent='Failed to load Three.js. Please ensure three.min.js is in the www directory.';}else{console.log('Three.js loaded successfully');initGame();}function initGame(){try{console.log('Initializing game with pedestrian pickup, enhanced buildings, and new features...');if(!window.WebGLRenderingContext||!document.createElement('canvas').getContext('webgl')){console.error('WebGL not supported');throw new Error('WebGL is not supported in this browser.');}console.log('WebGL supported, proceeding with initialization...');const xpOrbs=[];const items=[];const pedestrians=[];const spawnedCows=[];const equippedGear={'Head':null,'Mount':null};let isQuestActive=false;let questProgress={kills:0,goal:5};let questCompleted=false;let isInteractingWithNPC=false;let hasCompletedQuest=false;class Item{constructor(x,z,type){this.type=type;const colorMap={'Gem':0x00ff00,'Potion':0xff00ff,'Crate':0x8b4513,'Cow':0xffffff,'XP Orb':{red:0xff0000,blue:0x0000ff,yellow:0xffff00}};const geometryMap={'Gem':new THREE.SphereGeometry(0.15,16,16),'Potion':new THREE.SphereGeometry(0.15,16,16),'Crate':new THREE.BoxGeometry(0.3,0.3,0.3),'Cow':new THREE.BoxGeometry(0.5,0.4,0.3),'XP Orb':new THREE.SphereGeometry(0.15,16,16)};const color=type==='XP Orb'?colorMap[type][Math.floor(Math.random()*3)===0?'red':Math.floor(Math.random()*3)===1?'blue':'yellow']:colorMap[type];const geometry=geometryMap[type];this.mesh=new THREE.Mesh(geometry,new THREE.MeshBasicMaterial({color:color}));this.mesh.position.set(x,type==='Cow'?0.5:0.3,z);scene.add(this.mesh);console.log(`${type} spawned at (${x.toFixed(2)}, ${this.mesh.position.y.toFixed(2)}, ${z.toFixed(2)})`);}}const scene=new THREE.Scene();const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);const renderer=new THREE.WebGLRenderer();console.log('Renderer created');renderer.setSize(window.innerWidth,window.innerHeight);console.log('Renderer size set to',window.innerWidth,'x',window.innerHeight);document.body.appendChild(renderer.domElement);console.log('Renderer initialized:',renderer.domElement);const light=new THREE.DirectionalLight(0xffffff,0.8);light.position.set(10,10,10);scene.add(light);const ambientLight=new THREE.AmbientLight(0x404040);scene.add(ambientLight);console.log('Lighting added');let gameTime=0;const dayLength=120000;function updateDayNightCycle(){try{gameTime=(gameTime+16.67)%dayLength;const timeFraction=gameTime/dayLength;const isDay=timeFraction<0.5;const transition=Math.abs(Math.sin(timeFraction*Math.PI));light.intensity=isDay?0.8:0.4*transition;const ambientDayColor=new THREE.Color(0x404040);const ambientNightColor=new THREE.Color(0x101030);ambientLight.color.lerpColors(ambientNightColor,ambientDayColor,transition);const skyDayColor=new THREE.Color(0x87ceeb);const skyNightColor=new THREE.Color(0x2a2a5a);scene.background=skyDayColor.clone().lerp(skyNightColor,1-transition);updateClock(timeFraction);}catch(error){console.error('Error in updateDayNightCycle:',error);}}const clockCanvas=document.getElementById('clock-canvas');clockCanvas.width=50;clockCanvas.height=50;const clockCtx=clockCanvas.getContext('2d');function updateClock(timeFraction){try{const hours=timeFraction*24;const minutes=(hours%1)*60;clockCtx.clearRect(0,0,clockCanvas.width,clockCanvas.height);const centerX=clockCanvas.width/2;const centerY=clockCanvas.height/2;const radius=clockCanvas.width/2-5;clockCtx.beginPath();clockCtx.arc(centerX,centerY,radius,0,Math.PI*2);clockCtx.fillStyle='rgba(0,0,0,0.7)';clockCtx.fill();clockCtx.strokeStyle='#555';clockCtx.lineWidth=2;clockCtx.stroke();for(let i=0;i<12;i++){const angle=(i/12)*Math.PI*2-Math.PI/2;const markerLength=i%3===0?5:3;const startX=centerX+(radius-markerLength)*Math.cos(angle);const startY=centerY+(radius-markerLength)*Math.sin(angle);const endX=centerX+radius*Math.cos(angle);const endY=centerY+radius*Math.sin(angle);clockCtx.beginPath();clockCtx.moveTo(startX,startY);clockCtx.lineTo(endX,endY);clockCtx.strokeStyle='white';clockCtx.lineWidth=i%3===0?2:1;clockCtx.stroke();}const hourAngle=((hours%12)/12)*Math.PI*2-Math.PI/2;clockCtx.beginPath();clockCtx.moveTo(centerX,centerY);clockCtx.lineTo(centerX+(radius*0.5)*Math.cos(hourAngle),centerY+(radius*0.5)*Math.sin(hourAngle));clockCtx.strokeStyle='white';clockCtx.lineWidth=3;clockCtx.stroke();const minuteAngle=(minutes/60)*Math.PI*2-Math.PI/2;clockCtx.beginPath();clockCtx.moveTo(centerX,centerY);clockCtx.lineTo(centerX+(radius*0.8)*Math.cos(minuteAngle),centerY+(radius*0.8)*Math.sin(minuteAngle));clockCtx.strokeStyle='white';clockCtx.lineWidth=2;clockCtx.stroke();clockCtx.beginPath();clockCtx.arc(centerX,centerY,2,0,Math.PI*2);clockCtx.fillStyle='white';clockCtx.fill();}catch(error){console.error('Error in updateClock:',error);}}console.log('Analog clock initialized');const terrainGeometry=new THREE.PlaneGeometry(300,300,5,5);const forestMaterial=new THREE.MeshBasicMaterial({color:0x228B22,wireframe:true});const terrain=new THREE.Mesh(terrainGeometry,forestMaterial);terrain.rotation.x=-Math.PI/2;scene.add(terrain);console.log('Terrain added');const worldElements=[];const roadMaterial=new THREE.MeshBasicMaterial({color:0x555555});const roadGeometry=new THREE.PlaneGeometry(300,10);const road1=new THREE.Mesh(roadGeometry,roadMaterial);road1.rotation.x=-Math.PI/2;road1.position.set(0,0.01,50);scene.add(road1);worldElements.push({type:'road',mesh:road1,width:300,height:10});const road2=new THREE.Mesh(roadGeometry,roadMaterial);road2.rotation.x=-Math.PI/2;road2.rotation.z=Math.PI/2;road2.position.set(50,0.01,0);scene.add(road2);worldElements.push({type:'road',mesh:road2,width:10,height:300});console.log('Roads added');const buildingMaterial=new THREE.MeshBasicMaterial({color:0x888888});const roofMaterial=new THREE.MeshBasicMaterial({color:0x555555});const windowMaterial=new THREE.MeshBasicMaterial({color:0x00b7eb});const buildingGeometry=new THREE.BoxGeometry(10,10,10);const roofGeometry=new THREE.BoxGeometry(10.2,0.5,10.2);const windowGeometry=new THREE.BoxGeometry(2,2,0.1);const building1=new THREE.Group();const building1Base=new THREE.Mesh(buildingGeometry,buildingMaterial);building1Base.position.y=5;building1.add(building1Base);const building1Roof=new THREE.Mesh(roofGeometry,roofMaterial);building1Roof.position.y=10.25;building1.add(building1Roof);for(let x=-3;x<=3;x+=3){for(let y=2;y<=8;y+=3){const window=new THREE.Mesh(windowGeometry,windowMaterial);window.position.set(x,y,-5.05);building1.add(window);}}building1.position.set(-20,0,-20);scene.add(building1);worldElements.push({type:'building',mesh:building1,size:10});const building2=new THREE.Group();const building2Base=new THREE.Mesh(buildingGeometry,buildingMaterial);building2Base.position.y=5;building2.add(building2Base);const building2Roof=new THREE.Mesh(roofGeometry,roofMaterial);building2Roof.position.y=10.25;building2.add(building2Roof);for(let x=-3;x<=3;x+=3){for(let y=2;y<=8;y+=3){const window=new THREE.Mesh(windowGeometry,windowMaterial);window.position.set(x,y,5.05);building2.add(window);}}building2.position.set(20,0,20);scene.add(building2);worldElements.push({type:'building',mesh:building2,size:10});console.log('Buildings added with roofs and windows');const houses=[];const houseMaterial=new THREE.MeshBasicMaterial({color:0xdeb887});const houseBaseGeometry=new THREE.BoxGeometry(5,3,5);const houseRoofGeometry=new THREE.ConeGeometry(4,2,4);const house1=new THREE.Group();const house1Base=new THREE.Mesh(houseBaseGeometry,houseMaterial);house1Base.position.y=1.5;house1.add(house1Base);const house1Roof=new THREE.Mesh(houseRoofGeometry,houseMaterial);house1Roof.position.y=3.5;house1.add(house1Roof);house1.position.set(-30,0,30);scene.add(house1);worldElements.push({type:'house',mesh:house1,size:5});houses.push({mesh:house1,hasPedestrian:true});const house2=new THREE.Group();const house2Base=new THREE.Mesh(houseBaseGeometry,houseMaterial);house2Base.position.y=1.5;house2.add(house2Base);const house2Roof=new THREE.Mesh(houseRoofGeometry,houseMaterial);house2Roof.position.y=3.5;house2.add(house2Roof);house2.position.set(30,0,-30);scene.add(house2);worldElements.push({type:'house',mesh:house2,size:5});houses.push({mesh:house2,hasPedestrian:true});const house3=new THREE.Group();const house3Base=new THREE.Mesh(houseBaseGeometry,houseMaterial);house3Base.position.y=1.5;house3.add(house3Base);const house3Roof=new THREE.Mesh(houseRoofGeometry,houseMaterial);house3Roof.position.y=3.5;house3.add(house3Roof);house3.position.set(-100,0,-100);scene.add(house3);worldElements.push({type:'house',mesh:house3,size:5});houses.push({mesh:house3,hasPedestrian:true});const house4=new THREE.Group();const house4Base=new THREE.Mesh(houseBaseGeometry,houseMaterial);house4Base.position.y=1.5;house4.add(house4Base);const house4Roof=new THREE.Mesh(houseRoofGeometry,houseMaterial);house4Roof.position.y=3.5;house4.add(house4Roof);house4.position.set(100,0,100);scene.add(house4);worldElements.push({type:'house',mesh:house4,size:5});houses.push({mesh:house4,hasPedestrian:true});const house5=new THREE.Group();const house5Base=new THREE.Mesh(houseBaseGeometry,houseMaterial);house5Base.position.y=1.5;house5.add(house5Base);const house5Roof=new THREE.Mesh(houseRoofGeometry,houseMaterial);house5Roof.position.y=3.5;house5.add(house5Roof);house5.position.set(0,0,-100);scene.add(house5);worldElements.push({type:'house',mesh:house5,size:5});houses.push({mesh:house5,hasPedestrian:true});console.log('Houses added (total 5) with abduction capability');const carMaterial=new THREE.MeshBasicMaterial({color:0xff0000});const carGeometry=new THREE.BoxGeometry(4,1,2);const car1=new THREE.Mesh(carGeometry,carMaterial);car1.position.set(0,0.5,50);scene.add(car1);worldElements.push({type:'car',mesh:car1,width:4,height:2});const car2=new THREE.Mesh(carGeometry,carMaterial);car2.position.set(50,0.5,0);car2.rotation.y=Math.PI/2;scene.add(car2);worldElements.push({type:'car',mesh:car2,width:2,height:4});console.log('Cars added');const pedestrianMaterial=new THREE.MeshBasicMaterial({color:0x00ff00});const pedestrianGeometry=new THREE.BoxGeometry(0.5,1.5,0.5);const pedestrian1=new THREE.Mesh(pedestrianGeometry,pedestrianMaterial);pedestrian1.position.set(-10,0.75,55);pedestrian1.name='pedestrian1';scene.add(pedestrian1);pedestrians.push({mesh:pedestrian1,originalPosition:pedestrian1.position.clone(),path:[new THREE.Vector3(-140,0.75,55),new THREE.Vector3(140,0.75,55)],currentWaypointIndex:0,speed:1.5,baseY:0.75,animationOffset:Math.random()*Math.PI});worldElements.push({type:'pedestrian',mesh:pedestrian1,size:0.5});const pedestrian2=new THREE.Mesh(pedestrianGeometry,pedestrianMaterial);pedestrian2.position.set(55,0.75,-10);pedestrian2.name='pedestrian2';scene.add(pedestrian2);pedestrians.push({mesh:pedestrian2,originalPosition:pedestrian2.position.clone(),path:[new THREE.Vector3(55,0.75,-140),new THREE.Vector3(55,0.75,140)],currentWaypointIndex:0,speed:1.5,baseY:0.75,animationOffset:Math.random()*Math.PI});worldElements.push({type:'pedestrian',mesh:pedestrian2,size:0.5});console.log('Pedestrians added on sidewalk with movement paths, ready for tractor beam pickup');const playerGroup=new THREE.Group();const playerMaterial=new THREE.MeshBasicMaterial({color:0x0000ff});const torsoGeometry=new THREE.BoxGeometry(0.5,0.7,0.3);const torso=new THREE.Mesh(torsoGeometry,playerMaterial);torso.position.y=0.85;playerGroup.add(torso);const headGeometry=new THREE.SphereGeometry(0.2,32,32);const head=new THREE.Mesh(headGeometry,playerMaterial);head.position.y=1.3;playerGroup.add(head);const armGeometry=new THREE.BoxGeometry(0.2,0.5,0.2);const leftArm=new THREE.Mesh(armGeometry,playerMaterial);leftArm.position.set(-0.35,0.9,0);playerGroup.add(leftArm);const rightArm=new THREE.Mesh(armGeometry,playerMaterial);rightArm.position.set(0.35,0.9,0);playerGroup.add(rightArm);const swordGeometry=new THREE.BoxGeometry(0.1,0.8,0.05);const swordMaterial=new THREE.MeshBasicMaterial({color:0xcccccc});const sword=new THREE.Mesh(swordGeometry,swordMaterial);sword.position.set(0,-0.4,0);rightArm.add(sword);const legGeometry=new THREE.BoxGeometry(0.2,0.5,0.2);const leftLeg=new THREE.Mesh(legGeometry,playerMaterial);leftLeg.position.set(-0.15,0.25,0);playerGroup.add(leftLeg);const rightLeg=new THREE.Mesh(legGeometry,playerMaterial);rightLeg.position.set(0.15,0.25,0);playerGroup.add(rightLeg);const lunoParts=playerGroup.children.slice();playerGroup.position.y=0.5;scene.add(playerGroup);console.log('Player model (Luno) added');let isPilotingUFO=false;const ufoGroup=new THREE.Group();const ufoBaseGeometry=new THREE.CylinderGeometry(1,1,0.2,32);const ufoBaseMaterial=new THREE.MeshBasicMaterial({color:0xaaaaaa});const ufoBase=new THREE.Mesh(ufoBaseGeometry,ufoBaseMaterial);ufoBase.position.y=0.1;ufoGroup.add(ufoBase);const ufoDomeGeometry=new THREE.SphereGeometry(0.5,32,32,0,Math.PI*2,0,Math.PI/2);const ufoDomeMaterial=new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:0.5});const ufoDome=new THREE.Mesh(ufoDomeGeometry,ufoDomeMaterial);ufoDome.position.y=0.3;ufoGroup.add(ufoDome);ufoGroup.position.set(10,0.3,10);console.log('UFO initialized at (10, 0.3, 10)');scene.add(ufoGroup);let ufoLuno=null;let isTractorBeamActive=false;let liftedItem=null;const tractorBeamGeometry=new THREE.ConeGeometry(3,10,32);const tractorBeamMaterial=new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:0.3});const tractorBeam=new THREE.Mesh(tractorBeamGeometry,tractorBeamMaterial);tractorBeam.position.y=-5;tractorBeam.visible=false;console.log('Tractor beam initialized: skinny side at UFO, wide side at ground, height=10');ufoGroup.add(tractorBeam);function updateTractorBeam(){try{if(!isPilotingUFO||!isTractorBeamActive)return;if(ufoGroup.position.y>8){console.log(`UFO at high altitude (y=${ufoGroup.position.y.toFixed(2)}), detection may be less precise. Consider lowering with Shift.`);}if(!liftedItem){console.log(`Checking ${xpOrbs.length+items.length+pedestrians.length} targets for tractor beam, UFO at (${ufoGroup.position.x.toFixed(2)}, ${ufoGroup.position.y.toFixed(2)}, ${ufoGroup.position.z.toFixed(2)})`);let nearestItem=null;let minDistance=Infinity;let itemType=null;xpOrbs.forEach(item=>{if(item&&item.mesh&&item.mesh.position){const itemPos=item.mesh.position;const ufoPos=ufoGroup.position;const dx=ufoPos.x-itemPos.x;const dz=ufoPos.z-itemPos.z;const horizontalDistance=Math.sqrt(dx*dx+dz*dz);const verticalDistance=ufoPos.y-itemPos.y;const isWithinCylinder=horizontalDistance<=3&&verticalDistance>=0&&verticalDistance<=10;console.log(`XP Orb at (${itemPos.x.toFixed(2)}, ${itemPos.y.toFixed(2)}, ${itemPos.z.toFixed(2)}): horizontal=${horizontalDistance.toFixed(2)}, vertical=${verticalDistance.toFixed(2)}, inCylinder=${isWithinCylinder}`);if(isWithinCylinder){const distance=ufoPos.distanceTo(itemPos);if(distance<minDistance){minDistance=distance;nearestItem=item;itemType='xpOrb';}}}else{console.warn(`Invalid XP orb: ${JSON.stringify(item)}`);}});items.forEach(item=>{if(item&&item.mesh&&item.mesh.position){const itemPos=item.mesh.position;const ufoPos=ufoGroup.position;const dx=ufoPos.x-itemPos.x;const dz=ufoPos.z-itemPos.z;const horizontalDistance=Math.sqrt(dx*dx+dz*dz);const verticalDistance=ufoPos.y-itemPos.y;const isWithinCylinder=horizontalDistance<=3&&verticalDistance>=0&&verticalDistance<=10;console.log(`${item.type} at (${itemPos.x.toFixed(2)}, ${itemPos.y.toFixed(2)}, ${itemPos.z.toFixed(2)}): horizontal=${horizontalDistance.toFixed(2)}, vertical=${verticalDistance.toFixed(2)}, inCylinder=${isWithinCylinder}`);if(isWithinCylinder){const distance=ufoPos.distanceTo(itemPos);if(distance<minDistance){minDistance=distance;nearestItem=item;itemType='item';}}}else{console.warn(`Invalid item: ${JSON.stringify(item)}`);}});pedestrians.forEach(pedestrian=>{if(pedestrian&&pedestrian.mesh&&pedestrian.mesh.position){const pedPos=pedestrian.mesh.position;const ufoPos=ufoGroup.position;const dx=ufoPos.x-pedPos.x;const dz=ufoPos.z-pedPos.z;const horizontalDistance=Math.sqrt(dx*dx+dz*dz);const verticalDistance=ufoPos.y-pedPos.y;const isWithinCylinder=horizontalDistance<=3&&verticalDistance>=0&&verticalDistance<=10;console.log(`Pedestrian ${pedestrian.mesh.name} at (${pedPos.x.toFixed(2)}, ${pedPos.y.toFixed(2)}, ${pedPos.z.toFixed(2)}): horizontal=${horizontalDistance.toFixed(2)}, vertical=${verticalDistance.toFixed(2)}, inCylinder=${isWithinCylinder}`);if(isWithinCylinder){const distance=ufoPos.distanceTo(pedPos);if(distance<minDistance){minDistance=distance;nearestItem=pedestrian;itemType='pedestrian';}}}else{console.warn(`Invalid pedestrian: ${JSON.stringify(pedestrian)}`);}});if(nearestItem){liftedItem=nearestItem;liftedItemType=itemType;console.log(`Lifting ${itemType==='xpOrb'?'XP Orb':itemType==='item'?nearestItem.type:'Pedestrian '+nearestItem.mesh.name} at (${liftedItem.mesh.position.x.toFixed(2)}, ${liftedItem.mesh.position.y.toFixed(2)}, ${liftedItem.mesh.position.z.toFixed(2)})`);}else{console.log('No items or pedestrians within tractor beam cylinder');}}}catch(error){console.error('Error in updateTractorBeam:',error.message);}}let liftedItemType=null;let abductionTimer=0;let targetHouse=null;const launchedObjects=[];function releaseTractorBeam(){try{if(!isTractorBeamActive)return;isTractorBeamActive=false;tractorBeam.visible=false;if(liftedItem&&liftedItem.mesh){console.log(`Dropping ${liftedItemType==='xpOrb'?'XP Orb':liftedItemType==='item'?liftedItem.type:'Pedestrian '+liftedItem.mesh.name} at (${liftedItem.mesh.position.x.toFixed(2)}, ${liftedItem.mesh.position.y.toFixed(2)}, ${liftedItem.mesh.position.z.toFixed(2)})`);if(liftedItemType==='pedestrian'){liftedItem.mesh.position.copy(liftedItem.originalPosition);if(liftedItem.fromHouse){const house=houses.find(h=>h.mesh===liftedItem.fromHouse.mesh);if(house){house.hasPedestrian=true;console.log(`House at (${house.mesh.position.x.toFixed(2)}, ${house.mesh.position.z.toFixed(2)}) can now spawn another pedestrian`);}}}else{liftedItem.mesh.position.y=liftedItem.type==='Cow'?0.5:0.3;}liftedItem=null;liftedItemType=null;abductionTimer=0;targetHouse=null;}else{console.log('No item or pedestrian was lifted');}}catch(error){console.error('Error in releaseTractorBeam:',error.message);}}function enterUFO(){try{isPilotingUFO=true;scene.remove(playerGroup);ufoLuno=playerGroup.clone();ufoLuno.scale.set(0.5,0.5,0.5);ufoLuno.position.set(0,0.2,0);ufoGroup.add(ufoLuno);document.getElementById('skill-bar').style.display='none';console.log('Entered UFO');}catch(error){console.error('Error in enterUFO:',error);}}function exitUFO(){try{isPilotingUFO=false;ufoGroup.remove(ufoLuno);ufoLuno=null;ufoGroup.position.y=0.3;playerGroup.position.set(ufoGroup.position.x+1,0.5,ufoGroup.position.z);scene.add(playerGroup);if(isTractorBeamActive){releaseTractorBeam();}document.getElementById('skill-bar').style.display='flex';console.log(`Exited UFO, UFO positioned at (${ufoGroup.position.x.toFixed(2)}, ${ufoGroup.position.y.toFixed(2)}, ${ufoGroup.position.z.toFixed(2)})`);}catch(error){console.error('Error in exitUFO:',error);}}const npcGeometry=new THREE.BoxGeometry(0.5,1,0.5);const npcMaterial=new THREE.MeshBasicMaterial({color:0xffff00});const npc=new THREE.Mesh(npcGeometry,npcMaterial);npc.position.set(5,0.5,5);scene.add(npc);console.log('NPC initialized at (5, 0.5, 5)');const monsters=[];const targetMonsterCount=5;const respawnDelay=3000;class Monster{constructor(x,z){this.group=new THREE.Group();const bodyMaterial=new THREE.MeshBasicMaterial({color:0xff4500});const bodyGeometry=new THREE.ConeGeometry(0.4,1,8);const body=new THREE.Mesh(bodyGeometry,bodyMaterial);body.position.y=0.5;this.group.add(body);const spikeGeometry=new THREE.SphereGeometry(0.1,16,16);for(let i=0;i<4;i++){const spike=new THREE.Mesh(spikeGeometry,bodyMaterial);const angle=(i/4)*Math.PI*2;spike.position.set(Math.cos(angle)*0.4,0.3,Math.sin(angle)*0.4);this.group.add(spike);}this.group.position.set(x,0.5,z);this.health=100;this.isDying=false;scene.add(this.group);console.log(`Monster spawned at (${x.toFixed(2)}, 0.5, ${z.toFixed(2)})`);}takeDamage(damage){if(this.isDying)return;this.health-=damage;console.log(`Monster hit for ${damage} damage, health remaining: ${this.health}`);if(this.health<=0){this.die();}}die(){this.isDying=true;console.log('Monster dying');let scale=1;let opacity=1;let rotation=0;const die=()=>{if(scale>0){scale-=0.05;opacity-=0.05;rotation+=0.1;this.group.scale.set(scale,scale,scale);this.group.rotation.y=rotation;this.group.children.forEach(child=>{child.material.transparent=true;child.material.opacity=opacity;});requestAnimationFrame(die);}else{const dropType=Math.random();let itemType;if(dropType<0.4){itemType='XP Orb';}else if(dropType<0.6){itemType='Gem';}else if(dropType<0.75){itemType='Potion';}else if(dropType<0.9){itemType='Crate';}else{itemType='Cow';}console.log(`Monster drop roll: ${dropType.toFixed(2)}, dropping ${itemType}`);if(itemType==='XP Orb'){const orb=new Item(this.group.position.x,this.group.position.z,'XP Orb');xpOrbs.push(orb);console.log('Monster dropped XP orb');}else{const item=new Item(this.group.position.x,this.group.position.z,itemType);items.push(item);console.log(`Monster dropped ${itemType}`);}if(isQuestActive&&!questCompleted){questProgress.kills=Math.min(questProgress.kills+1,questProgress.goal);console.log(`Monster killed, quest progress: ${questProgress.kills}/${questProgress.goal}`);updateQuestTracker();if(isInteractingWithNPC){updateQuestUI();}}scene.remove(this.group);const index=monsters.indexOf(this);if(index!==-1){monsters.splice(index,1);}console.log('Monster removed, respawning...');setTimeout(()=>{spawnMonstersToMaintainCount();},respawnDelay);}};die();}}function spawnMonstersToMaintainCount(){try{while(monsters.length<targetMonsterCount){const x=Math.min(Math.max(playerGroup.position.x+(Math.random()*50-25),-150),150);const z=Math.min(Math.max(playerGroup.position.z+(Math.random()*50-25),-150),150);const newMonster=new Monster(x,z);monsters.push(newMonster);console.log(`Spawned Monster at (${x.toFixed(2)}, 0.5, ${z.toFixed(2)}), total monsters: ${monsters.length}`);}}catch(error){console.error('Error in spawnMonstersToMaintainCount:',error);}}spawnMonstersToMaintainCount();console.log('Monsters initialized:',monsters.length);let playerHealth=100;let playerXP=0;let playerLevel=1;function getXPForLevel(level){try{return Math.round(25*level*(1+level/5));}catch(error){console.error('Error in getXPForLevel:',error);return 25;}}function showLevelUpPopup(newLevel){try{const popup=document.getElementById('level-up-popup');popup.textContent=`Level Up! You are now Level ${newLevel}!`;popup.style.display='block';popup.style.opacity='0';setTimeout(()=>{popup.style.opacity='1';},10);setTimeout(()=>{popup.style.opacity='0';setTimeout(()=>{popup.style.display='none';},500);},2500);console.log(`Level up to ${newLevel}!`);}catch(error){console.error('Error in showLevelUpPopup:',error);}}function updateXPandLevel(){try{const xpNeeded=getXPForLevel(playerLevel);while(playerXP>=xpNeeded){playerXP-=xpNeeded;playerLevel++;showLevelUpPopup(playerLevel);}document.getElementById('xp-counter').textContent=`XP: ${playerXP}/${xpNeeded}`;document.getElementById('xp-fill').style.width=`${(playerXP/xpNeeded)*100}%`;document.getElementById('level-display').textContent=`Level: ${playerLevel}`;document.getElementById('health-fill').style.width=`${playerHealth}%`;}catch(error){console.error('Error in updateXPandLevel:',error);}}updateXPandLevel();console.log('Player stats and UI initialized');const npcMessage=document.getElementById('npc-message');const npcMessageContent=document.getElementById('npc-message-content');const npcMessageButtons=document.getElementById('npc-message-buttons');const questTracker=document.getElementById('quest-tracker');function showQuestPopup(message){try{console.log(`Showing quest popup: ${message}`);const popup=document.getElementById('quest-received-popup');popup.textContent=message;popup.style.display='block';popup.style.opacity='0';setTimeout(()=>{popup.style.opacity='1';},10);setTimeout(()=>{popup.style.opacity='0';setTimeout(()=>{popup.style.display='none';},500);},2500);}catch(error){console.error('Error in showQuestPopup:',error);}}function updateQuestTracker(){try{if(isQuestActive){questTracker.style.display='block';questTracker.textContent=`Quest: Slay Monsters ${questProgress.kills}/${questProgress.goal}`;}else{questTracker.style.display='none';}}catch(error){console.error('Error in updateQuestTracker:',error);}}function updateQuestUI(){try{console.log('Updating Quest UI, isQuestActive:',isQuestActive,'Kills:',questProgress.kills);npcMessageButtons.innerHTML='';if(isQuestActive){questTracker.style.display='block';questTracker.textContent=`Quest: Slay Monsters ${questProgress.kills}/${questProgress.goal}`;if(questProgress.kills>=questProgress.goal&&!questCompleted){questCompleted=true;console.log('Quest completed! Showing Turn In button');npcMessageContent.textContent='Quest complete! Here’s your reward!';const turnInButton=document.createElement('button');turnInButton.id='turn-in-quest-button';turnInButton.className='npc-button';turnInButton.textContent='Turn In';turnInButton.addEventListener('click',handleTurnInQuest);npcMessageButtons.appendChild(turnInButton);}else if(!questCompleted){npcMessageContent.textContent='Keep going, brave adventurer!';}else{npcMessageContent.textContent='Quest complete! Here’s your reward!';const turnInButton=document.createElement('button');turnInButton.id='turn-in-quest-button';turnInButton.className='npc-button';turnInButton.textContent='Turn In';turnInButton.addEventListener('click',handleTurnInQuest);npcMessageButtons.appendChild(turnInButton);}}else{questTracker.style.display='none';npcMessageContent.textContent=hasCompletedQuest?'Accept quest again?':'Will you slay 5 monsters for me?';const acceptButton=document.createElement('button');acceptButton.id='accept-quest-button';acceptButton.className='npc-button';acceptButton.textContent='Accept';acceptButton.addEventListener('click',handleAcceptQuest);const declineButton=document.createElement('button');declineButton.id='decline-quest-button';declineButton.className='npc-button';declineButton.textContent='Decline';declineButton.addEventListener('click',handleDeclineQuest);npcMessageButtons.appendChild(acceptButton);npcMessageButtons.appendChild(declineButton);}}catch(error){console.error('Error in updateQuestUI:',error);}}function handleAcceptQuest(e){try{e.stopPropagation();e.preventDefault();console.log('Accept button clicked');isQuestActive=true;questProgress.kills=0;questCompleted=false;spawnMonstersToMaintainCount();showQuestPopup('Quest Received!');updateQuestUI();}catch(error){console.error('Error in handleAcceptQuest:',error);}}function handleDeclineQuest(e){try{e.stopPropagation();e.preventDefault();console.log('Decline button clicked');npcMessageContent.textContent='Hello, Luno! Stay brave out there!';npcMessageButtons.innerHTML='';}catch(error){console.error('Error in handleDeclineQuest:',error);}}function handleTurnInQuest(e){try{e.stopPropagation();e.preventDefault();console.log('Turn In button clicked, resetting quest state');if(!hasCompletedQuest){console.log('Awarding Wizard Hat');addToInventory('Wizard Hat');showQuestPopup('Quest Completed! You received a Wizard Hat cosmetic!');}else{console.log('Awarding 50 XP');playerXP+=50;updateXPandLevel();showQuestPopup('Quest Completed! You received 50 XP!');}hasCompletedQuest=true;isQuestActive=false;questCompleted=false;questProgress.kills=0;questTracker.style.display='none';npcMessage.style.display='none';npcMessageContent.textContent='';npcMessageButtons.innerHTML='';isInteractingWithNPC=false;console.log('Quest state reset, isQuestActive:',isQuestActive,'questCompleted:',questCompleted);}catch(error){console.error('Error in handleTurnInQuest:',error);}}console.log('Quest system initialized');const characterCanvas=document.getElementById('character-canvas');characterCanvas.width=100;characterCanvas.height=100;const characterRenderer=new THREE.WebGLRenderer({canvas:characterCanvas,alpha:true});const characterScene=new THREE.Scene();const characterCamera=new THREE.PerspectiveCamera(75,1,0.1,1000);characterCamera.position.set(0,1,2);characterCamera.lookAt(0,1,0);const characterLight=new THREE.DirectionalLight(0xffffff,0.8);characterLight.position.set(1,1,1);characterScene.add(characterLight);characterScene.add(new THREE.AmbientLight(0x404040));const characterGroup=playerGroup.clone();characterScene.add(characterGroup);function updateCharacterDisplay(){try{characterScene.remove(characterGroup);characterGroup.children=[];if(equippedGear['Mount']){const cowClone=equippedGear['Mount'].clone(true);cowClone.position.set(0,0.3,0);characterGroup.add(cowClone);lunoParts.forEach(part=>{const partClone=part.clone(true);partClone.position.y+=0.3;characterGroup.add(partClone);});}else{lunoParts.forEach(part=>{characterGroup.add(part.clone(true));});}if(equippedGear['Head']){const hatClone=equippedGear['Head'].clone(true);hatClone.position.set(0,1.5,0);hatClone.name='wizardHat';characterGroup.add(hatClone);}characterScene.add(characterGroup);document.getElementById('equipped-gear').textContent=`Head: ${equippedGear['Head']?'Wizard Hat':'None'}\nMount: ${equippedGear['Mount']?'Cow':'None'}`;document.getElementById('unequip-button').style.display=equippedGear['Head']?`block`:`none`;document.getElementById('unequip-mount-button').style.display=equippedGear['Mount']?`block`:`none`;}catch(error){console.error('Error in updateCharacterDisplay:',error);}}function renderCharacterDisplay(){try{characterRenderer.render(characterScene,characterCamera);}catch(error){console.error('Error in renderCharacterDisplay:',error);}}renderCharacterDisplay();console.log('Character display setup complete');const gearTypes={'Gem':{slot:'None',maxStack:64},'Potion':{slot:'None',maxStack:64},'Crate':{slot:'None',maxStack:64},'Cow':{slot:'Mount',maxStack:64},'Wizard Hat':{slot:'Head',maxStack:1}};let inventory=Array(10).fill(null).map(()=>({type:null,slot:'None',count:0}));function addToInventory(type){try{let added=false;const gearInfo=gearTypes[type];const stackSize=gearInfo.maxStack;const slot=gearInfo.slot;for(let i=0;i<inventory.length;i++){if(inventory[i].type===type&&inventory[i].count<stackSize){inventory[i].count++;added=true;break;}}if(!added){for(let i=0;i<inventory.length;i++){if(inventory[i].type===null||inventory[i].count===0){inventory[i]={type:type,slot:slot,count:1};added=true;break;}}}if(added){updateInventory();console.log(`Added ${type} to inventory`);}else{console.log(`Inventory full, cannot add ${type}`);}}catch(error){console.error('Error in addToInventory:',error.message);}}const inventoryGrid=document.getElementById('inventory-grid');for(let i=0;i<10;i++){const slot=document.createElement('div');slot.className='inventory-slot';slot.addEventListener('click',()=>{try{const item=inventory[i];if(item.count>0&&item.slot!=='None'&&!isPilotingUFO&&!equippedGear[item.slot]){if(item.slot==='Head'){addWizardHat();}else if(item.slot==='Mount'){equipCowMount();}inventory[i].count--;if(inventory[i].count===0){inventory[i].type=null;inventory[i].slot='None';}updateInventory();updateCharacterDisplay();console.log(`Equipped ${item.type} to ${item.slot} slot`);}else if(item.type==='Cow'&&item.count>0&&!isPilotingUFO){const spawnPos=playerGroup.position.clone();spawnPos.z-=1;const cow=new Item(spawnPos.x,spawnPos.z,'Cow');items.push(cow);spawnedCows.push(cow);inventory[i].count--;if(inventory[i].count===0){inventory[i].type=null;inventory[i].slot='None';}updateInventory();console.log('Spawned a cow from inventory at ('+spawnPos.x.toFixed(2)+', 0.5, '+spawnPos.z.toFixed(2)+')');}}catch(error){console.error('Error in inventory slot click:',error);}});inventoryGrid.appendChild(slot);}function updateInventory(){try{inventoryGrid.childNodes.forEach((slot,i)=>{const item=inventory[i];slot.textContent=item.type&&item.count>0?`${item.type} x${item.count}`:'';});}catch(error){console.error('Error in updateInventory:',error);}}function addWizardHat(){const hatGeometry=new THREE.ConeGeometry(0.25,0.4,32);const hatMaterial=new THREE.MeshBasicMaterial({color:0x800080});const wizardHat=new THREE.Mesh(hatGeometry,hatMaterial);wizardHat.position.set(0,1.5,0);wizardHat.name='wizardHat';playerGroup.add(wizardHat);equippedGear['Head']=wizardHat;updateCharacterDisplay();}function removeWizardHat(){const wizardHat=playerGroup.getObjectByName('wizardHat');if(wizardHat){playerGroup.remove(wizardHat);addToInventory('Wizard Hat');equippedGear['Head']=null;updateCharacterDisplay();console.log('Unequipped Wizard Hat');}}function equipCowMount(){const cowGeometry=new THREE.BoxGeometry(0.8,0.6,0.4);const cowMaterial=new THREE.MeshBasicMaterial({color:0xffffff});const cowMesh=new THREE.Mesh(cowGeometry,cowMaterial);cowMesh.name='cowMount';cowMesh.position.set(0,0.3,0);playerGroup.add(cowMesh);lunoParts.forEach(part=>{part.position.y+=0.3;});playerGroup.position.y=0.3;equippedGear['Mount']=cowMesh;updateCharacterDisplay();}function unequipCowMount(){const cowMount=playerGroup.getObjectByName('cowMount');if(cowMount){playerGroup.remove(cowMount);lunoParts.forEach(part=>{part.position.y-=0.3;});playerGroup.position.y=0.5;addToInventory('Cow');equippedGear['Mount']=null;updateCharacterDisplay();console.log('Unequipped Cow mount');}}document.getElementById('unequip-button').addEventListener('click',()=>{try{if(equippedGear['Head']){removeWizardHat();}}catch(error){console.error('Error in unequip button click:',error);}});document.getElementById('unequip-mount-button').addEventListener('click',()=>{try{if(equippedGear['Mount']){unequipCowMount();}}catch(error){console.error('Error in unequip mount button click:',error);}});console.log('Inventory and character display system initialized');function showPickupMessage(itemType){const messageDiv=document.getElementById('pickup-message');messageDiv.textContent=`Picked up: ${itemType}`;messageDiv.style.display='block';messageDiv.style.opacity='0';setTimeout(()=>{messageDiv.style.opacity='1';},10);setTimeout(()=>{messageDiv.style.opacity='0';setTimeout(()=>{messageDiv.style.display='none';},500);},2000);}const joystickBase=document.getElementById('joystick-base');const joystick=document.getElementById('joystick');let touchActive=false;let touchId=null;let moveDir=new THREE.Vector2(0,0);joystickBase.addEventListener('touchstart',e=>{e.preventDefault();if(!touchActive){touchActive=true;touchId=e.touches[0].identifier;const touch=e.touches[0];const rect=joystickBase.getBoundingClientRect();const x=(touch.clientX-rect.left-40)/40;const y=(touch.clientY-rect.top-40)/40;moveDir.set(x,-y).clampLength(0,1);joystick.style.left=`${40+x*20}px`;joystick.style.top=`${40+y*20}px`;}},false);joystickBase.addEventListener('touchmove',e=>{e.preventDefault();if(touchActive){for(let touch of e.touches){if(touch.identifier===touchId){const rect=joystickBase.getBoundingClientRect();const x=(touch.clientX-rect.left-40)/40;const y=(touch.clientY-rect.top-40)/40;moveDir.set(x,-y).clampLength(0,1);joystick.style.left=`${40+x*20}px`;joystick.style.top=`${40+y*20}px`;break;}}}},false);joystickBase.addEventListener('touchend',e=>{for(let touch of e.changedTouches){if(touch.identifier===touchId){touchActive=false;touchId=null;moveDir.set(0,0);joystick.style.left='40px';joystick.style.top='40px';break;}}},false);document.getElementById('skill1-touch').addEventListener('touchstart',e=>{e.preventDefault();swingSword();});document.getElementById('skill2-touch').addEventListener('touchstart',e=>{e.preventDefault();stabSword();});document.getElementById('skill3-touch').addEventListener('touchstart',e=>{e.preventDefault();spinAttack();});document.getElementById('interact-touch').addEventListener('touchstart',e=>{e.preventDefault();if(!isActing){if(!isPilotingUFO&&playerGroup.position.distanceTo(ufoGroup.position)<2){enterUFO();}else if(isPilotingUFO){exitUFO();}}});document.getElementById('inventory-touch').addEventListener('touchstart',e=>{e.preventDefault();const inventoryDisplay=inventoryGrid.parentElement.style.display==='none'?'block':'none';inventoryGrid.parentElement.style.display=inventoryDisplay;document.getElementById('character-display').style.display=inventoryDisplay;console.log('Toggled inventory and character display visibility:',inventoryDisplay);});document.getElementById('tractor-beam-touch').addEventListener('touchstart',e=>{e.preventDefault();if(isPilotingUFO){if(!isTractorBeamActive){console.log('Touch: Activating tractor beam');isTractorBeamActive=true;tractorBeam.visible=true;updateTractorBeam();}else{console.log('Touch: Releasing tractor beam');releaseTractorBeam();}}});document.getElementById('launch-touch').addEventListener('touchstart',e=>{e.preventDefault();if(isPilotingUFO&&isTractorBeamActive&&liftedItem){let launchDirection=moveDir.length()>0?new THREE.Vector3(moveDir.x,0,-moveDir.y):new THREE.Vector3(0,0,-1);launchDirection.normalize().multiplyScalar(20);launchDirection.y=5;launchedObjects.push({object:liftedItem,type:liftedItemType,velocity:launchDirection,gravity:-9.8});console.log(`Launched ${liftedItemType==='xpOrb'?'XP Orb':liftedItemType==='item'?liftedItem.type:'Pedestrian '+liftedItem.mesh.name} with velocity (${launchDirection.x.toFixed(2)}, ${launchDirection.y.toFixed(2)}, ${launchDirection.z.toFixed(2)})`);isTractorBeamActive=false;tractorBeam.visible=false;liftedItem=null;liftedItemType=null;abductionTimer=0;targetHouse=null;}});const minimapCanvas=document.getElementById('minimap');minimapCanvas.width=150;minimapCanvas.height=150;const minimapCtx=minimapCanvas.getContext('2d');const worldSize=300;const minimapScale=150/worldSize;function updateMinimap(){try{minimapCtx.clearRect(0,0,minimapCanvas.width,minimapCanvas.height);minimapCtx.fillStyle='rgba(34,139,34,0.5)';minimapCtx.fillRect(0,0,150,150);minimapCtx.strokeStyle='gray';minimapCtx.lineWidth=2;minimapCtx.strokeRect(0,0,150,150);worldElements.forEach(element=>{const pos=element.mesh.position;const relX=(pos.x+150)*minimapScale;const relZ=(pos.z+150)*minimapScale;if(element.type==='road'){const width=element.width*minimapScale;const height=element.height*minimapScale;minimapCtx.fillStyle='gray';minimapCtx.fillRect(relX-width/2,relZ-height/2,width,height);}else if(element.type==='building'){const size=element.size*minimapScale;minimapCtx.fillStyle='gray';minimapCtx.fillRect(relX-size/2,relZ-size/2,size,size);}else if(element.type==='house'){const size=element.size*minimapScale;minimapCtx.fillStyle='brown';minimapCtx.fillRect(relX-size/2,relZ-size/2,size,size);}else if(element.type==='car'){const width=element.width*minimapScale;const height=element.height*minimapScale;minimapCtx.fillStyle='red';minimapCtx.fillRect(relX-width/2,relZ-height/2,width,height);}else if(element.type==='pedestrian'){const isLifted=liftedItem&&liftedItem.mesh===element.mesh;minimapCtx.fillStyle=isLifted?'white':'green';const size=element.size*minimapScale;minimapCtx.beginPath();minimapCtx.arc(relX,relZ,size,0,Math.PI*2);minimapCtx.fill();}});const pos=isPilotingUFO?ufoGroup.position:playerGroup.position;const playerX=(pos.x+150)*minimapScale;const playerZ=(pos.z+150)*minimapScale;minimapCtx.fillStyle=isPilotingUFO?'green':'blue';minimapCtx.beginPath();minimapCtx.arc(playerX,playerZ,3,0,Math.PI*2);minimapCtx.fill();minimapCtx.fillStyle='red';monsters.forEach(monster=>{if(monster&&monster.group&&monster.group.position){const relX=(monster.group.position.x+150)*minimapScale;const relZ=(monster.group.position.z+150)*minimapScale;if(relX>=0&&relX<=150&&relZ>=0&&relZ<=150){minimapCtx.beginPath();minimapCtx.arc(relX,relZ,3,0,Math.PI*2);minimapCtx.fill();}}});minimapCtx.fillStyle='yellow';xpOrbs.forEach(orb=>{if(orb&&orb.mesh&&orb.mesh.position){const isLifted=liftedItem&&orb===liftedItem;minimapCtx.fillStyle=isLifted?'white':'yellow';const orbX=(orb.mesh.position.x+150)*minimapScale;const orbZ=(orb.mesh.position.z+150)*minimapScale;if(orbX>=0&&orbX<=150&&orbZ>=0&&orbZ<=150){minimapCtx.beginPath();minimapCtx.arc(orbX,orbZ,2,0,Math.PI*2);minimapCtx.fill();}}});items.forEach(item=>{if(item&&item.mesh&&item.mesh.position){const isLifted=liftedItem&&item===liftedItem;minimapCtx.fillStyle=isLifted?'white':(item.type==='Gem'?'green':item.type==='Potion'?'purple':item.type==='Crate'?'brown':'white');const itemX=(item.mesh.position.x+150)*minimapScale;const itemZ=(item.mesh.position.z+150)*minimapScale;if(itemX>=0&&itemX<=150&&itemZ>=0&&itemZ<=150){minimapCtx.beginPath();minimapCtx.arc(itemX,itemZ,2,0,Math.PI*2);minimapCtx.fill();}}});minimapCtx.fillStyle='yellow';const npcRelX=(npc.position.x+150)*minimapScale;const npcRelZ=(npc.position.z+150)*minimapScale;if(npcRelX>=0&&npcRelX<=150&&npcRelZ>=0&&npcRelZ<=150){minimapCtx.beginPath();minimapCtx.arc(npcRelX,npcRelZ,3,0,Math.PI*2);minimapCtx.fill();}if(!isPilotingUFO){minimapCtx.fillStyle='green';const ufoRelX=(ufoGroup.position.x+150)*minimapScale;const ufoRelZ=(ufoGroup.position.z+150)*minimapScale;if(ufoRelX>=0&&ufoRelX<=150&&ufoRelZ>=0&&ufoRelZ<=150){minimapCtx.beginPath();minimapCtx.arc(ufoRelX,ufoRelZ,3,0,Math.PI*2);minimapCtx.fill();}}}catch(error){console.error('Error in updateMinimap:',error.message);}}console.log('Minimap initialized');let isActing=false;let currentSkillIndex=0;const skills=[swingSword,stabSword,spinAttack];function swingSword(){if(isActing||isPilotingUFO)return;isActing=true;console.log('Swing attack triggered');let angle=0;const swingSpeed=0.1;function animateSwing(){if(angle<Math.PI/2){rightArm.rotation.z=-angle;angle+=swingSpeed;requestAnimationFrame(animateSwing);}else{rightArm.rotation.z=0;isActing=false;console.log('Swing attack completed');}}animateSwing();const playerPos=playerGroup.position;monsters.forEach(monster=>{if(playerPos.distanceTo(monster.group.position)<2){monster.takeDamage(20);}});}function stabSword(){if(isActing||isPilotingUFO)return;isActing=true;console.log('Stab attack triggered');let offset=0;const stabSpeed=0.05;function animateStab(){if(offset<0.5){rightArm.position.z=offset;offset+=stabSpeed;requestAnimationFrame(animateStab);}else{rightArm.position.z=0;isActing=false;console.log('Stab attack completed');}}animateStab();const playerPos=playerGroup.position;monsters.forEach(monster=>{if(playerPos.distanceTo(monster.group.position)<2.5){monster.takeDamage(30);}});}function spinAttack(){if(isActing||isPilotingUFO)return;isActing=true;console.log('Spin attack triggered');let angle=0;const spinSpeed=0.1;function animateSpin(){if(angle<Math.PI*2){playerGroup.rotation.y=angle;angle+=spinSpeed;requestAnimationFrame(animateSpin);}else{playerGroup.rotation.y=0;isActing=false;console.log('Spin attack completed');}}animateSpin();const playerPos=playerGroup.position;monsters.forEach(monster=>{if(playerPos.distanceTo(monster.group.position)<3){monster.takeDamage(15);}});}const keys={};document.addEventListener('keydown',e=>{try{keys[e.key.toLowerCase()]=true;if(keys['1'])swingSword();if(keys['2'])stabSword();if(keys['3'])spinAttack();if(e.key.toLowerCase()==='i'){const inventoryDisplay=inventoryGrid.parentElement.style.display==='none'?'block':'none';inventoryGrid.parentElement.style.display=inventoryDisplay;document.getElementById('character-display').style.display=inventoryDisplay;console.log('Toggled inventory and character display visibility:',inventoryDisplay);}if(e.key.toLowerCase()==='e'&&!isActing){if(!isPilotingUFO&&playerGroup.position.distanceTo(ufoGroup.position)<2){enterUFO();}else if(isPilotingUFO){exitUFO();}}if(keys['q']&&isPilotingUFO&&isTractorBeamActive&&liftedItem){let launchDirection=new THREE.Vector3(0,0,0);if(keys['w'])launchDirection.z-=1;if(keys['s'])launchDirection.z+=1;if(keys['a'])launchDirection.x-=1;if(keys['d'])launchDirection.x+=1;if(launchDirection.length()===0){launchDirection.z=-1;}launchDirection.normalize();launchDirection.multiplyScalar(20);launchDirection.y=5;launchedObjects.push({object:liftedItem,type:liftedItemType,velocity:launchDirection,gravity:-9.8});console.log(`Launched ${liftedItemType==='xpOrb'?'XP Orb':liftedItemType==='item'?liftedItem.type:'Pedestrian '+liftedItem.mesh.name} with velocity (${launchDirection.x.toFixed(2)}, ${launchDirection.y.toFixed(2)}, ${launchDirection.z.toFixed(2)})`);isTractorBeamActive=false;tractorBeam.visible=false;liftedItem=null;liftedItemType=null;abductionTimer=0;targetHouse=null;}}catch(error){console.error('Error in keydown event:',error);}});document.addEventListener('keyup',e=>{try{keys[e.key.toLowerCase()]=false;}catch(error){console.error('Error in keyup event:',error);}});document.addEventListener('mousedown',e=>{try{if(e.button===0&&!e.target.classList.contains('skill')&&!e.target.classList.contains('npc-button')&&!e.target.classList.contains('inventory-slot')&&e.target.id!=='unequip-button'&&e.target.id!=='unequip-mount-button'){skills[currentSkillIndex]();currentSkillIndex=(currentSkillIndex+1)%skills.length;console.log('Mouse click: Using skill',skills[currentSkillIndex].name);}else if(e.button===2&&isPilotingUFO){console.log('RMB down: Activating tractor beam');isTractorBeamActive=true;tractorBeam.visible=true;updateTractorBeam();}}catch(error){console.error('Error in mousedown event:',error);}});document.addEventListener('mouseup',e=>{try{if(e.button===2&&isPilotingUFO){console.log('RMB up: Releasing tractor beam');releaseTractorBeam();}}catch(error){console.error('Error in mouseup event:',error);}});document.addEventListener('contextmenu',e=>{try{e.preventDefault();}catch(error){console.error('Error in contextmenu event:',error);}});console.log('Controls initialized (WASD, 1-2-3, Mouse Click, I for Inventory, E for UFO, Space/Shift for UFO height, RMB for Tractor Beam, Q to Launch)');document.getElementById('skill1').addEventListener('click',()=>{swingSword();console.log('Skill bar: Swing clicked');});document.getElementById('skill2').addEventListener('click',()=>{stabSword();console.log('Skill bar: Stab clicked');});document.getElementById('skill3').addEventListener('click',()=>{spinAttack();console.log('Skill bar: Spin clicked');});console.log('Skill bar actions initialized');let lastSpawnCheck=0;const spawnCheckInterval=1000;function animate(timestamp){try{requestAnimationFrame(animate);updateDayNightCycle();const speed=isPilotingUFO?0.2:(equippedGear['Mount']?0.25:0.15);const target=isPilotingUFO?ufoGroup:playerGroup;const newPos=target.position.clone();if(touchActive&&moveDir.length()>0){newPos.x+=moveDir.x*speed;newPos.z-=moveDir.y*speed;}else{if(keys['w'])newPos.z-=speed;if(keys['s'])newPos.z+=speed;if(keys['a'])newPos.x-=speed;if(keys['d'])newPos.x+=speed;}newPos.x=Math.max(Math.min(newPos.x,150),-150);newPos.z=Math.max(Math.min(newPos.z,150),-150);target.position.copy(newPos);if(isPilotingUFO){if(keys[' '])target.position.y=Math.min(target.position.y+0.1,10);if(keys['shift'])target.position.y=Math.max(target.position.y-0.1,0.3);document.getElementById('tractor-beam-touch').style.display='block';document.getElementById('launch-touch').style.display='block';}else{target.position.y=equippedGear['Mount']?0.3:0.5;document.getElementById('tractor-beam-touch').style.display='none';document.getElementById('launch-touch').style.display='none';}if(timestamp-lastSpawnCheck>spawnCheckInterval){spawnMonstersToMaintainCount();lastSpawnCheck=timestamp;}pedestrians.forEach(pedestrian=>{if(liftedItem&&pedestrian.mesh===liftedItem.mesh)return;const currentWaypoint=pedestrian.path[pedestrian.currentWaypointIndex];const nextWaypointIndex=(pedestrian.currentWaypointIndex+1)%pedestrian.path.length;const nextWaypoint=pedestrian.path[nextWaypointIndex];const direction=currentWaypoint.clone().sub(pedestrian.mesh.position);const distanceToWaypoint=direction.length();const speedPerFrame=pedestrian.speed/60;if(distanceToWaypoint>0){direction.normalize();const moveDistance=Math.min(speedPerFrame,distanceToWaypoint);pedestrian.mesh.position.add(direction.multiplyScalar(moveDistance));}if(distanceToWaypoint<0.5){pedestrian.currentWaypointIndex=nextWaypointIndex;}const bobAmplitude=0.05;const bobFrequency=2*Math.PI*2;const bobOffset=Math.sin(Date.now()*0.001*bobFrequency+pedestrian.animationOffset)*bobAmplitude;pedestrian.mesh.position.y=pedestrian.baseY+bobOffset;});spawnedCows.forEach((cow,index)=>{if(liftedItem&&cow===liftedItem)return;const direction=playerGroup.position.clone().sub(cow.mesh.position);const distance=direction.length();if(distance>1.5){direction.normalize();const speedPerFrame=1.5/60;const moveDistance=Math.min(speedPerFrame,distance-1.5);cow.mesh.position.add(direction.multiplyScalar(moveDistance));}const bobAmplitude=0.05;const bobFrequency=2*Math.PI*2;const bobOffset=Math.sin(Date.now()*0.001*bobFrequency+index)*bobAmplitude;cow.mesh.position.y=0.5+bobOffset;});if(!isPilotingUFO){xpOrbs.forEach((orb,index)=>{if(playerGroup.position.distanceTo(orb.mesh.position)<1){playerXP+=10;updateXPandLevel();scene.remove(orb.mesh);xpOrbs.splice(index,1);console.log('Collected XP orb, XP increased by 10');showPickupMessage('XP Orb');}});items.forEach((item,index)=>{if(playerGroup.position.distanceTo(item.mesh.position)<1){addToInventory(item.type);scene.remove(item.mesh);items.splice(index,1);console.log(`Collected ${item.type} on foot`);showPickupMessage(item.type);}});}launchedObjects.forEach((launched,index)=>{const obj=launched.object;const velocity=launched.velocity;const gravity=launched.gravity;obj.mesh.position.x+=velocity.x*(1/60);obj.mesh.position.z+=velocity.z*(1/60);obj.mesh.position.y+=velocity.y*(1/60);velocity.y+=gravity*(1/60);obj.mesh.position.x=Math.max(Math.min(obj.mesh.position.x,150),-150);obj.mesh.position.z=Math.max(Math.min(obj.mesh.position.z,150),-150);const groundY=launched.type==='pedestrian'?0.75:(launched.type==='Cow'?0.5:0.3);if(obj.mesh.position.y<=groundY){obj.mesh.position.y=groundY;if(launched.type==='pedestrian'&&obj.fromHouse){const house=houses.find(h=>h.mesh===obj.fromHouse.mesh);if(house){house.hasPedestrian=true;console.log(`House at (${house.mesh.position.x.toFixed(2)}, ${house.mesh.position.z.toFixed(2)}) can now spawn another pedestrian`);}obj.mesh.position.copy(obj.originalPosition);}launchedObjects.splice(index,1);console.log(`${launched.type==='xpOrb'?'XP Orb':launched.type==='item'?launched.object.type:'Pedestrian '+launched.object.mesh.name} landed at (${obj.mesh.position.x.toFixed(2)}, ${obj.mesh.position.y.toFixed(2)}, ${obj.mesh.position.z.toFixed(2)})`);}});if(isPilotingUFO&&isTractorBeamActive&&!liftedItem){let foundHouse=false;houses.forEach(house=>{const housePos=house.mesh.position;const ufoPos=ufoGroup.position;const dx=ufoPos.x-housePos.x;const dz=ufoPos.z-housePos.z;const horizontalDistance=Math.sqrt(dx*dx+dz*dz);const verticalDistance=ufoPos.y-housePos.y;const isAboveHouse=horizontalDistance<=5&&verticalDistance>=0&&verticalDistance<=10;if(isAboveHouse&&house.hasPedestrian){foundHouse=true;if(targetHouse!==house){targetHouse=house;abductionTimer=0;}abductionTimer+=1/60;console.log(`Tractor beam above house at (${housePos.x.toFixed(2)}, ${housePos.z.toFixed(2)}), abduction timer: ${abductionTimer.toFixed(2)}s`);if(abductionTimer>=1.5){const pedestrianMaterial=new THREE.MeshBasicMaterial({color:0x00ff00});const pedestrianGeometry=new THREE.BoxGeometry(0.5,1.5,0.5);const newPedestrian=new THREE.Mesh(pedestrianGeometry,pedestrianMaterial);newPedestrian.position.set(housePos.x,0.75,housePos.z);newPedestrian.name=`housePedestrian_${houses.indexOf(house)}`;scene.add(newPedestrian);const pedestrianObj={mesh:newPedestrian,originalPosition:newPedestrian.position.clone(),fromHouse:house};pedestrians.push(pedestrianObj);worldElements.push({type:'pedestrian',mesh:newPedestrian,size:0.5});console.log(`Abducted pedestrian from house at (${housePos.x.toFixed(2)}, ${housePos.z.toFixed(2)})`);liftedItem=pedestrianObj;liftedItemType='pedestrian';house.hasPedestrian=false;abductionTimer=0;targetHouse=null;}}});if(!foundHouse){abductionTimer=0;targetHouse=null;}}else{abductionTimer=0;targetHouse=null;}updateTractorBeam();if(isTractorBeamActive&&liftedItem&&liftedItem.mesh){const targetY=Math.max(ufoGroup.position.y-1,liftedItem.type==='Cow'?0.5:liftedItemType==='pedestrian'?0.75:0.3);liftedItem.mesh.position.lerp(new THREE.Vector3(ufoGroup.position.x,targetY,ufoGroup.position.z),0.1);liftedItem.mesh.position.x=Math.max(Math.min(liftedItem.mesh.position.x,150),-150);liftedItem.mesh.position.z=Math.max(Math.min(liftedItem.mesh.position.z,150),-150);console.log(`Moving lifted ${liftedItemType==='xpOrb'?'XP orb':liftedItemType==='item'?liftedItem.type:'Pedestrian '+liftedItem.mesh.name} to (${liftedItem.mesh.position.x.toFixed(2)}, ${liftedItem.mesh.position.y.toFixed(2)}, ${liftedItem.mesh.position.z.toFixed(2)})`);if(liftedItemType!=='pedestrian'&&ufoGroup.position.distanceTo(liftedItem.mesh.position)<1.5){if(liftedItemType==='xpOrb'){const index=xpOrbs.indexOf(liftedItem);if(index!==-1){playerXP+=10;updateXPandLevel();scene.remove(liftedItem.mesh);xpOrbs.splice(index,1);liftedItem=null;liftedItemType=null;isTractorBeamActive=false;tractorBeam.visible=false;console.log('Collected XP orb with tractor beam, XP increased by 10');showPickupMessage('XP Orb');}}else if(liftedItemType==='item'){const index=items.indexOf(liftedItem);if(index!==-1){addToInventory(liftedItem.type);scene.remove(liftedItem.mesh);items.splice(index,1);liftedItem=null;liftedItemType=null;isTractorBeamActive=false;tractorBeam.visible=false;console.log(`Collected ${liftedItem.type} with tractor beam`);showPickupMessage(liftedItem.type);}}}}}if(!isPilotingUFO&&playerGroup.position.distanceTo(npc.position)<3){if(!isInteractingWithNPC){npcMessage.style.display='block';updateQuestUI();isInteractingWithNPC=true;}}else{if(isInteractingWithNPC){npcMessage.style.display='none';if(!isQuestActive){npcMessageContent.textContent='';npcMessageButtons.innerHTML='';}isInteractingWithNPC=false;}}const cameraTarget=isPilotingUFO?ufoGroup:playerGroup;camera.position.set(cameraTarget.position.x,cameraTarget.position.y+7,cameraTarget.position.z+15);camera.lookAt(cameraTarget.position);if(isTractorBeamActive){tractorBeam.material.opacity=0.3+0.1*Math.sin(Date.now()*0.002);}updateXPandLevel();updateMinimap();renderCharacterDisplay();renderer.render(scene,camera);console.log('Frame rendered:',timestamp);}catch(error){console.error('Error in animate loop:',error.message);document.getElementById('error-message').style.display='block';document.getElementById('error-message').textContent='Error in game loop: '+error.message;}}animate(0);console.log('Animation loop started');window.addEventListener('resize',()=>{try{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);minimapCanvas.width=150;minimapCanvas.height=150;clockCanvas.width=50;clockCanvas.height=50;characterCanvas.width=100;characterCanvas.height=100;}catch(error){console.error('Error in window resize:',error);}});console.log('Window resize handler added');}catch(error){console.error('Critical error in main script:',error);document.getElementById('error-message').style.display='block';document.getElementById('error-message').textContent='Failed to initialize game: '+error.message;}}</script></body></html>